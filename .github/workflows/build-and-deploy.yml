name: Build and Deploy

on:
  push:
    branches:
      - main
    paths:
      - '**.php'
      - '**.js'
      - '**.css'
      - 'Dockerfile'
      - '.github/workflows/build-and-deploy.yml'
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Build Docker image
        run: |
          docker build -t benahinyuk:latest -t benahinyuk:${{ github.sha }} .
          
      - name: Save and encode image
        run: |
          docker save benahinyuk:latest | gzip | base64 -w 0 > /tmp/image.tar.gz.b64
          echo "IMAGE_B64=$(cat /tmp/image.tar.gz.b64)" >> $GITHUB_ENV
      
      - name: Create image artifact
        run: |
          mkdir -p artifacts
          docker save benahinyuk:latest -o artifacts/benahinyuk-latest.tar
      
      - name: Upload image artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: artifacts/benahinyuk-latest.tar
          retention-days: 1
  
  trigger-deployment:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update k8s/deployment.yaml
        run: |
          TIMESTAMP=$(date +%s)
          sed -i "s/image: benahinyuk:latest/image: benahinyuk:latest-${TIMESTAMP}/g" k8s/deployment.yaml
          sed -i "s/image: benahinyuk:latest-${TIMESTAMP}/image: benahinyuk:latest/g" k8s/deployment.yaml
          
      - name: Commit and push if changed
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          if [ -n "$(git status -s)" ]; then
            git add k8s/deployment.yaml
            git commit -m "chore: trigger deployment refresh [skip ci]"
            git push origin main
          else
            echo "No changes detected"
          fi

